{
    "abstractText": "Even though neural networks enjoy widespread use, they still struggle to learn the basic laws of physics. How might we endow them with better inductive biases? In this paper, we draw inspiration from Hamiltonian mechanics to train models that learn and respect exact conservation laws in an unsupervised manner. We evaluate our models on problems where conservation of energy is important, including the two-body problem and pixel observations of a pendulum. Our model trains faster and generalizes better than a regular neural network. An interesting side effect is that our model is perfectly reversible in time. Ideal mass-spring system Noisy observations Baseline NN Prediction Prediction Hamiltonian NN Figure 1: Learning the Hamiltonian of a mass-spring system. The variables q and p correspond to position and momentum coordinates. As there is no friction, the baseline\u2019s inner spiral is due to model errors. By comparison, the Hamiltonian Neural Network learns to exactly conserve a quantity that is analogous to total energy.",
    "authors": [
        {
            "affiliations": [],
            "name": "Sam Greydanus"
        },
        {
            "affiliations": [],
            "name": "Misko Dzamba"
        }
    ],
    "id": "SP:9a3b6958761f4702e2c92f7726f6770d8099fd7d",
    "references": [
        {
            "authors": [
                "M. Andrychowicz",
                "B. Baker",
                "M. Chociej",
                "R. Jozefowicz",
                "B. McGrew",
                "J. Pachocki",
                "A. Petron",
                "M. Plappert",
                "G. Powell",
                "A Ray"
            ],
            "title": "Learning dexterous in-hand manipulation",
            "venue": "arXiv preprint arXiv:1808.00177,",
            "year": 2018
        },
        {
            "authors": [
                "P. Battaglia",
                "R. Pascanu",
                "M. Lai",
                "Rezende",
                "D. J"
            ],
            "title": "Interaction networks for learning about objects, relations and physics",
            "venue": "In Advances in neural information processing systems,",
            "year": 2016
        },
        {
            "authors": [
                "J. Behler"
            ],
            "title": "Neural network potential-energy surfaces in chemistry: a tool for large-scale simulations",
            "venue": "Physical Chemistry Chemical Physics,",
            "year": 2011
        },
        {
            "authors": [
                "R. Bondesan",
                "A. Lamacraft"
            ],
            "title": "Learning symmetries of classical integrable systems",
            "venue": "arXiv preprint arXiv:1906.04645,",
            "year": 2019
        },
        {
            "authors": [
                "M.B. Chang",
                "T. Ullman",
                "A. Torralba",
                "J.B. Tenenbaum"
            ],
            "title": "A compositional object-based approach to learning physical dynamics",
            "venue": "arXiv preprint arXiv:1612.00341,",
            "year": 2016
        },
        {
            "authors": [
                "T.Q. Chen",
                "Y. Rubanova",
                "J. Bettencourt",
                "D.K. Duvenaud"
            ],
            "title": "Neural ordinary differential equations",
            "venue": "pp. 6571\u20136583,",
            "year": 2018
        },
        {
            "authors": [
                "S. Chmiela",
                "A. Tkatchenko",
                "H.E. Sauceda",
                "I. Poltavsky",
                "K.T. Sch\u00fctt",
                "M\u00fcller",
                "K.-R"
            ],
            "title": "Machine learning of accurate energy-conserving molecular force fields",
            "venue": "Science advances,",
            "year": 2017
        },
        {
            "authors": [
                "C. Cohen-Tannoudji",
                "J. Dupont-Roc",
                "G. Grynberg"
            ],
            "title": "Photons and atoms-introduction to quantum electrodynamics. Photons and Atoms-Introduction to Quantum Electrodynamics",
            "year": 1997
        },
        {
            "authors": [
                "F. de Avila Belbute-Peres",
                "K. Smith",
                "K. Allen",
                "J. Tenenbaum",
                "J.Z. Kolter"
            ],
            "title": "End-to-end differentiable physics for learning and control",
            "venue": "In Advances in Neural Information Processing Systems,",
            "year": 2018
        },
        {
            "authors": [
                "M. Gastegger",
                "P. Marquetand"
            ],
            "title": "High-dimensional neural network potentials for organic reactions and an improved training algorithm",
            "venue": "Journal of chemical theory and computation,",
            "year": 2015
        },
        {
            "authors": [
                "S.M. Girvin",
                "K. Yang"
            ],
            "title": "Modern condensed matter physics",
            "year": 2019
        },
        {
            "authors": [
                "A.N. Gomez",
                "M. Ren",
                "R. Urtasun",
                "R.B. Grosse"
            ],
            "title": "The reversible residual network: Backpropagation without storing activations",
            "venue": "In Advances in neural information processing systems,",
            "year": 2017
        },
        {
            "authors": [
                "D. Ha",
                "J. Schmidhuber"
            ],
            "title": "Recurrent world models facilitate policy evolution",
            "venue": "In Advances in Neural Information Processing Systems,",
            "year": 2018
        },
        {
            "authors": [
                "D. Hafner",
                "T. Lillicrap",
                "I. Fischer",
                "R. Villegas",
                "D. Ha",
                "H. Lee",
                "J. Davidson"
            ],
            "title": "Learning latent dynamics for planning from pixels",
            "venue": "arXiv preprint arXiv:1811.04551,",
            "year": 2018
        },
        {
            "authors": [
                "J.B. Hamrick",
                "K.R. Allen",
                "V. Bapst",
                "T. Zhu",
                "K.R. McKee",
                "J.B. Tenenbaum",
                "P.W. Battaglia"
            ],
            "title": "Relational inductive bias for physical construction in humans and machines",
            "venue": "arXiv preprint arXiv:1806.01203,",
            "year": 2018
        },
        {
            "authors": [
                "R. Iten",
                "T. Metger",
                "H. Wilming",
                "L. Del Rio",
                "R. Renner"
            ],
            "title": "Discovering physical concepts with neural networks",
            "venue": "arXiv preprint arXiv:1807.10300,",
            "year": 2018
        },
        {
            "authors": [
                "Jacobsen",
                "J.-H",
                "A. Smeulders",
                "E. Oyallon"
            ],
            "title": "i-revnet: Deep invertible networks",
            "venue": "arXiv preprint arXiv:1802.07088,",
            "year": 2018
        },
        {
            "authors": [
                "D.P. Kingma",
                "J. Ba"
            ],
            "title": "Adam: A method for stochastic optimization",
            "venue": "International Conference on Learning Representations,",
            "year": 2014
        },
        {
            "authors": [
                "A. Krizhevsky",
                "I. Sutskever",
                "G. Hinton"
            ],
            "title": "Imagenet classification with deep convolutional neural networks",
            "venue": "In Advances in Neural Information Processing Systems",
            "year": 2012
        },
        {
            "authors": [
                "S. Levine",
                "P. Pastor",
                "A. Krizhevsky",
                "J. Ibarz",
                "D. Quillen"
            ],
            "title": "Learning hand-eye coordination for robotic grasping with deep learning and large-scale data collection",
            "venue": "The International Journal of Robotics Research,",
            "year": 2018
        },
        {
            "authors": [
                "R. Liu",
                "J. Lehman",
                "P. Molino",
                "F.P. Such",
                "E. Frank",
                "A. Sergeev",
                "J. Yosinski"
            ],
            "title": "An intriguing failing of convolutional neural networks and the coordconv solution",
            "venue": "In Advances in Neural Information Processing Systems,",
            "year": 2018
        },
        {
            "authors": [
                "M. Lutter",
                "C. Ritter",
                "J. Peters"
            ],
            "title": "Deep lagrangian networks: Using physics as model prior for deep learning",
            "venue": "International Conference on Learning Representations,",
            "year": 2019
        },
        {
            "authors": [
                "M. MacKay",
                "P. Vicol",
                "J. Ba",
                "R.B. Grosse"
            ],
            "title": "Reversible recurrent neural networks",
            "venue": "In Advances in Neural Information Processing Systems,",
            "year": 2018
        },
        {
            "authors": [
                "V. Mnih",
                "K. Kavukcuoglu",
                "D. Silver",
                "A. Graves",
                "I. Antonoglou",
                "D. Wierstra",
                "M. Riedmiller"
            ],
            "title": "Playing Atari with Deep Reinforcement Learning",
            "year": 2013
        },
        {
            "authors": [
                "E. Noether"
            ],
            "title": "Invariant variation problems",
            "venue": "Transport Theory and Statistical Physics,",
            "year": 1971
        },
        {
            "authors": [
                "A. Pukrittayakamee",
                "M. Malshe",
                "M. Hagan",
                "L. Raff",
                "R. Narulkar",
                "S. Bukkapatnum",
                "R. Komanduri"
            ],
            "title": "Simultaneous fitting of a potential-energy surface and its corresponding force fields using feedforward neural networks",
            "venue": "The Journal of chemical physics,",
            "year": 2009
        },
        {
            "authors": [
                "L.E. Reichl"
            ],
            "title": "A modern course in statistical physics",
            "venue": "AAPT,",
            "year": 1999
        },
        {
            "authors": [
                "M. Rupp",
                "A. Tkatchenko",
                "M\u00fcller",
                "K.-R",
                "O.A. Von Lilienfeld"
            ],
            "title": "Fast and accurate modeling of molecular atomization energies with machine learning",
            "venue": "Physical review letters,",
            "year": 2012
        },
        {
            "authors": [
                "J.J. Sakurai",
                "E.D. Commins"
            ],
            "title": "Modern quantum mechanics, revised edition",
            "venue": "AAPT,",
            "year": 1995
        },
        {
            "authors": [
                "R. Salmon"
            ],
            "title": "Hamiltonian fluid mechanics",
            "venue": "Annual review of fluid mechanics,",
            "year": 1988
        },
        {
            "authors": [
                "A. Santoro",
                "D. Raposo",
                "D.G. Barrett",
                "M. Malinowski",
                "R. Pascanu",
                "P. Battaglia",
                "T. Lillicrap"
            ],
            "title": "A simple neural network module for relational reasoning",
            "venue": "In Advances in neural information processing systems,",
            "year": 2017
        },
        {
            "authors": [
                "M. Schmidt",
                "H. Lipson"
            ],
            "title": "Distilling free-form natural laws from experimental data",
            "venue": "Science, 324(5923):81\u201385,",
            "year": 2009
        },
        {
            "authors": [
                "K.T. Sch\u00fctt",
                "F. Arbabzadah",
                "S. Chmiela",
                "K.R. M\u00fcller",
                "A. Tkatchenko"
            ],
            "title": "Quantumchemical insights from deep tensor neural networks",
            "venue": "Nature communications,",
            "year": 2017
        },
        {
            "authors": [
                "D. Silver",
                "J. Schrittwieser",
                "K. Simonyan",
                "I. Antonoglou",
                "A. Huang",
                "A. Guez",
                "T. Hubert",
                "L. Baker",
                "M. Lai",
                "A Bolton"
            ],
            "title": "Mastering the game of go without human knowledge",
            "year": 2017
        },
        {
            "authors": [
                "J.S. Smith",
                "O. Isayev",
                "A.E. Roitberg"
            ],
            "title": "Ani-1: an extensible neural network potential with dft accuracy at force field computational cost",
            "venue": "Chemical science,",
            "year": 2017
        },
        {
            "authors": [
                "J.B. Tenenbaum",
                "V. De Silva",
                "J.C. Langford"
            ],
            "title": "A global geometric framework for nonlinear dimensionality reduction",
            "year": 2000
        },
        {
            "authors": [
                "J. Tompson",
                "K. Schlachter",
                "P. Sprechmann",
                "K. Perlin"
            ],
            "title": "Accelerating eulerian fluid simulation with convolutional networks",
            "venue": "In Proceedings of the 34th International Conference on Machine Learning-Volume",
            "year": 2017
        },
        {
            "authors": [
                "J. Wang",
                "S. Olsson",
                "C. Wehmeyer",
                "A. Perez",
                "N.E. Charron",
                "G. de Fabritiis",
                "F. Noe",
                "C. Clementi"
            ],
            "title": "Machine learning of coarse-grained molecular dynamics force fields",
            "venue": "ACS Central Science,",
            "year": 2018
        },
        {
            "authors": [
                "N. Watters",
                "D. Zoran",
                "T. Weber",
                "P. Battaglia",
                "R. Pascanu",
                "A. Tacchetti"
            ],
            "title": "Visual interaction networks: Learning a physics simulator from video",
            "venue": "In Advances in neural information processing systems,",
            "year": 2017
        },
        {
            "authors": [
                "K. Yao",
                "J.E. Herr",
                "D.W. Toth",
                "R. Mckintyre",
                "J. Parkhill"
            ],
            "title": "The tensormol-0.1 model chemistry: A neural network augmented with long-range physics",
            "venue": "Chemical science,",
            "year": 2018
        }
    ],
    "sections": [
        {
            "text": "Ideal mass-spring system\nNoisy observations\nBaseline NN Prediction\nPredictionHamiltonian NN\nFigure 1: Learning the Hamiltonian of a mass-spring system. The variables q and p correspond to position and momentum coordinates. As there is no friction, the baseline\u2019s inner spiral is due to model errors. By comparison, the Hamiltonian Neural Network learns to exactly conserve a quantity that is analogous to total energy."
        },
        {
            "heading": "1 Introduction",
            "text": "Neural networks have a remarkable ability to learn and generalize from data. This lets them excel at tasks such as image classification [21], reinforcement learning [45, 26, 37], and robotic dexterity [1, 22]. Even though these tasks are diverse, they all share the same underlying physical laws. For example, a notion of gravity is important for reasoning about objects in an image, training an RL agent to walk, or directing a robot to manipulate objects. Based on this observation, researchers have become increasingly interested in finding physics priors that transfer across tasks [43, 34, 17, 10, 6, 40].\nPreprint. Under review.\nar X\niv :1\n90 6.\n01 56\n3v 3\n[ cs\n.N E\n] 5\nS ep\n2 01\n9\nUntrained neural networks do not have physics priors; they learn approximate physics knowledge directly from data. This generally prevents them from learning exact physical laws. Consider the frictionless mass-spring system shown in Figure 1. Here the total energy of the system is being conserved. More specifically, this particular system conserves a quantity proportional to q2 + p2, where q is the position and p is the momentum of the mass. The baseline neural network in Figure 1 learns an approximation of this conservation law, and yet the approximation is imperfect enough that a forward simulation of the system drifts over time to higher or lower energy states. Can we define a class of neural networks that will precisely conserve energy-like quantities over time?\nIn this paper, we draw inspiration from Hamiltonian mechanics, a branch of physics concerned with conservation laws and invariances, to define Hamiltonian Neural Networks, or HNNs. We begin with an equation called the Hamiltonian, which relates the state of a system to some conserved quantity (usually energy) and lets us simulate how the system changes with time. Physicists generally use domain-specific knowledge to find this equation, but here we try a different approach:\nInstead of crafting the Hamiltonian by hand, we propose parameterizing it with a neural network and then learning it directly from data.\nSince almost all physical laws can be expressed as conservation laws, our approach is quite general [27]. In practice, our model trains quickly and generalizes well1. Figure 1, for example, shows the outcome of training an HNN on the same mass-spring system. Unlike the baseline model, it learns to conserve an energy-like quantity."
        },
        {
            "heading": "2 Theory",
            "text": "Predicting dynamics. The hallmark of a good physics model is its ability to predict changes in a system over time. This is the challenge we now turn to. In particular, our goal is to learn the dynamics of a system using a neural network. The simplest way of doing this is by predicting the next state of a system given the current one. A variety of previous works have taken this path and produced excellent results [41, 14, 43, 34, 17, 6]. There are, however, a few problems with this approach.\nThe first problem is its notion of discrete \u201ctime steps\u201d that connect neighboring states. Since time is actually continuous, a better approach would be to express dynamics as a set of differential equations and then integrate them from an initial state at t0 to a final state at t1. Equation 1 shows how this might be done, letting S denote the time derivatives of the coordinates of the system2. This approach has been under-explored so far, but techniques like Neural ODEs take a step in the right direction [7].\n(q1,p1) = (q0,p0) + \u222b t1 t0 S(q,p) dt (1)\nThe second problem with existing methods is that they tend not to learn exact conservation laws or invariant quantities. This often causes them to drift away from the true dynamics of the system as small errors accumulate. The HNN model that we propose ameliorates both of these problems. To see how it does this \u2014 and to situate our work in the proper context \u2014 we first briefly review Hamiltonian mechanics.\nHamiltonian Mechanics. William Hamilton introduced Hamiltonian mechanics in the 19th century as a mathematical reformulation of classical mechanics. Its original purpose was to express classical mechanics in a more unified and general manner. Over time, though, scientists have applied it to nearly every area of physics from thermodynamics to quantum field theory [29, 32, 39].\nIn Hamiltonian mechanics, we begin with a set of coordinates (q,p). Usually, q = (q1, ..., qN ) represents the positions of a set of objects whereas p = (p1, ..., pN ) denotes their momentum. Note how this gives us N coordinate pairs (q1, p1)...(qN , pN ). Taken together, they offer a complete description of the system. Next, we define a scalar function,H(q,p) called the Hamiltonian so that\ndq dt = \u2202H \u2202p , dp dt = \u2212\u2202H \u2202q . (2)\n1We make our code available at github.com/greydanus/hamiltonian-nn. 2Any coordinates that describe the state of the system. Later we will use position and momentum (p, q).\nEquation 2 tells us that moving coordinates in the direction SH = ( \u2202H \u2202p ,\u2212 \u2202H \u2202q ) gives us the time evolution of the system. We can think of S as a vector field over the inputs of H. In fact, it is a special kind of vector field called a \u201csymplectic gradient\u201d. Whereas moving in the direction of the gradient ofH changes the output as quickly as possible, moving in the direction of the symplectic gradient keeps the output exactly constant. Hamilton used this mathematical framework to relate the position and momentum vectors (q,p) of a system to its total energy Etot = H(q,p). Then, he found SH using Equation 2 and obtained the dynamics of the system by integrating this field according to Equation 1. This is a powerful approach because it works for almost any system where the total energy is conserved.\nHamiltonian mechanics, like Newtonian mechanics, can predict the motion of a mass-spring system or a single pendulum. But its true strengths only become apparent when we tackle systems with many degrees of freedom. Celestial mechanics, which are chaotic for more than two bodies, are a good example. A few other examples include many-body quantum systems, fluid simulations, and condensed matter physics [29, 32, 39, 33, 9, 12].\nHamiltonian Neural Networks. In this paper, we propose learning a parametric function for H instead of SH. In doing so, we endow our model with the ability to learn exactly conserved quantities from data in an unsupervised manner. During the forward pass, it consumes a set of coordinates and outputs a single scalar \u201cenergy-like\u201d value. Then, before computing the loss, we take an in-graph gradient of the output with respect to the input coordinates (Figure A.1). It is with respect to this gradient that we compute and optimize an L2 loss (Equation 3).\nLHNN = \u2225\u2225\u2225\u2225\u2202H\u03b8\u2202p \u2212 \u2202q\u2202t \u2225\u2225\u2225\u2225 2 + \u2225\u2225\u2225\u2225\u2202H\u03b8\u2202q + \u2202p\u2202t \u2225\u2225\u2225\u2225 2\n(3)\nFor a visual comparison between this approach and the baseline, refer to Figure 1 or Figure 1(b). This training procedure allows HNNs to learn conserved quantities analogous to total energy straight from data. Apart from conservation laws, HNNs have several other interesting and potentially useful properties. First, they are perfectly reversible in that the mapping from (q,p) at one time to (q,p) at another time is bijective. Second, we can manipulate the HNN-conserved quantity (analogous to total energy) by integrating along the gradient ofH, giving us an interesting counterfactual tool (e.g. \u201cWhat would happen if we added 1 Joule of energy?\u201d). We\u2019ll discuss these properties later in Section 6."
        },
        {
            "heading": "3 Learning a Hamiltonian from Data",
            "text": "Optimizing the gradients of a neural network is a rare approach. There are a few previous works which do this [42, 35, 28], but their scope and implementation details diverge from this work and from one another. With this in mind, our first step was to investigate the empirical properties of HNNs on three simple physics tasks.\nTask 1: Ideal Mass-Spring. Our first task was to model the dynamics of the frictionless mass-spring system shown in Figure 1. The system\u2019s Hamiltonian is given in Equation 4 where k is the spring constant and m is the mass constant. For simplicity, we set k = m = 1. Then we sampled initial coordinates with total energies uniformly distributed between [0.2, 1]. We constructed training and test sets of 25 trajectories each and added Gaussian noise with standard deviation \u03c32 = 0.1 to every data point. Each trajectory had 30 observations; each observation was a concatenation of (q,p).\nH = 1 2 kq2 +\np2\n2m (4)\nTask 2: Ideal Pendulum. Our second task was to model a frictionless pendulum. Pendulums are nonlinear oscillators so they present a slightly more difficult problem. Writing the gravitational constant as g and the length of the pendulum as l, the general Hamiltonian is\nH = 2mgl(1\u2212 cos q) + l 2p2\n2m (5)\nOnce again we set m = l = 1 for simplicity. This time, we set g = 3 and sampled initial coordinates with total energies in the range [1.3, 2.3]. We chose these numbers in order to situate the dataset along the system\u2019s transition from linear to nonlinear dynamics. As with Task 1, we constructed training and test sets of 25 trajectories each and added the same amount of noise.\nTask 3: Real Pendulum. Our third task featured the position and momentum readings from a real pendulum. We used data from a Science paper by Schmidt & Lipson [35] which also tackled the problem of learning conservation laws from data. This dataset was noisier than the synthetic ones and it did not strictly obey any conservation laws since the real pendulum had a small amount of friction. Our goal here was to examine how HNNs fared on noisy and biased real-world data."
        },
        {
            "heading": "3.1 Methods",
            "text": "In all three tasks, we trained our models with a learning rate of 10\u22123 and used the Adam optimizer [20]. Since the training sets were small, we set the batch size to be the total number of examples. On each dataset we trained two fully-connected neural networks: the first was a baseline model that, given a vector input (q,p) output the vector (\u2202q/\u2202t, \u2202p/\u2202t) directly. The second was an HNN that estimated the same vector using the derivative of a scalar quantity as shown in Equation 2 (also see Figure A.1). Where possible, we used analytic time derivatives as the targets. Otherwise, we calculated finite difference approximations. All of our models had three layers, 200 hidden units, and tanh activations. We trained them for 2000 gradient steps and evaluated them on the test set.\nWe logged three metrics: L2 train loss, L2 test loss, and mean squared error (MSE) between the true and predicted total energies. To determine the energy metric, we integrated our models according to Equation 1 starting from a random test point. Then we used MSE to measure how much a given model\u2019s dynamics diverged from the ground truth. Intuitively, the loss metrics measure our model\u2019s ability to fit individual data points while the energy metric measures its stability and conservation of energy over long timespans. To obtain dynamics, we integrated our models with the fourth-order Runge-Kutta integrator in scipy.integrate.solve_ivp and set the error tolerance to 10\u22129 [30]."
        },
        {
            "heading": "3.2 Results",
            "text": "We found that HNNs train as quickly as baseline models and converge to similar final losses. Table 1 shows their relative performance over the three tasks. But even as HNNs tied with the baseline on on loss, they dramatically outperformed it on the MSE energy metric. Figure 2 shows why this is the case: as we integrate the two models over time, various errors accumulate in the baseline and it eventually diverges. Meanwhile, the HNN conserves a quantity that closely resembles total energy and diverges more slowly or not at all.\nIt\u2019s worth noting that the quantity conserved by the HNN is not equivalent to the total energy; rather, it\u2019s something very close to the total energy. The third and fourth columns of Figure 2 provide a useful comparison between the HNN-conserved quantity and the total energy. Looking closely at the spacing of the y axes, one can see that the HNN-conserved quantity has the same scale as total energy, but differs by a constant factor. Since energy is a relative quantity, this is perfectly acceptable3.\nThe total energy plot for the real pendulum shows another interesting pattern. Whereas the ground truth data does not quite conserve total energy, the HNN roughly conserves this quantity. This, in fact, is a fundamental limitation of HNNs: they assume a conserved quantity exists and thus are unable to account for things that violate this assumpation, such as friction. In order to account for friction, we would need to model it separately from the HNN."
        },
        {
            "heading": "4 Modeling Larger Systems",
            "text": "Having established baselines on a few simple tasks, our next step was to tackle a larger system involving more than one pair of (p, q) coordinates. One well-studied problem that fits this description is the two-body problem, which requires four (p, q) pairs.\nH = |pCM| 2 m1 +m2 + |p1|2 + |p2|2 2\u00b5 + g m1m2 |q1 \u2212 q2|2\n(6)\nTask 4: Two-body problem. In the two-body problem, point particles interact with one another via an attractive force such as gravity. Once again, we let g be the gravitational constant and m represent mass. Equation 6 gives the Hamiltonian of the system where \u00b5 is the reduced mass and pCM is the momentum of the center of mass. As in previous tasks, we set m1 = m2 = g = 1 for simplicity. Furthermore, we restricted our experiments to systems where the momentum of the center of mass was zero. Even so, with eight degrees of freedom (given by the x and y position and momentum coordinates of the two bodies) this system represented an interesting challenge."
        },
        {
            "heading": "4.1 Methods",
            "text": "Our first step was to generate a dataset of 1000 near-circular, two-body trajectories. We initialized every trajectory with center of mass zero, total momentum zero, and radius r = \u2016q2 \u2212 q1\u2016 in the range [0.5, 1.5]. In order to control the level of numerical stability, we chose initial velocities that gave perfectly circular orbits and then added Gaussian noise to them. We found that scaling this noise by a factor of \u03c32 = 0.05 produced trajectories with a good balance between stability and diversity.\nWe used fourth-order Runge-Kutta integration to find 200 trajectories of 50 observations each and then performed an 80/20% train/test set split over trajectories. Our models and training procedure were identical to those described in Section 3 except this time we trained for 10,000 gradient steps and used a batch size of 200."
        },
        {
            "heading": "4.2 Results",
            "text": "The HNN model scaled well to this system. The first row of Figure 3 suggests that it learned to conserve a quantity nearly equal to the total energy of the system whereas the baseline model did not.\nThe second row of Figure 3 gives a qualitative comparison of trajectories. After one orbit, the baseline dynamics have completely diverged from the ground truth whereas the HNN dynamics have only accumulated a small amount of error. As we continue to integrate up to t = 50 and beyond (Figure B.1), both models diverge but the HNN does so at a much slower rate. Even as the HNN\n3To see why energy is relative, imagine a cat that is at an elevation of 0 m in one reference frame and 1 m in another. Its potential energy (and total energy) will differ by a constant factor depending on frame of reference.\ndiverges from the ground truth orbit, its total energy remains stable rather than decaying to zero or spiraling to infinity. We report quantitative results for this task in Table 1. Both train and test losses of the HNN model were about an order of magnitude lower than those of the baseline. The HNN did a better job of conserving total energy, with an energy MSE that was several orders of magnitude below the baseline.\nHaving achieved success on the two-body problem, we ran the same set of experiments on the chaotic three-body problem. We show preliminary results in Appendix B where once again the HNN outperforms its baseline by a considerable margin. We opted to focus on the two-body results here because the three-body results still need improvement."
        },
        {
            "heading": "5 Learning a Hamiltonian from Pixels",
            "text": "One of the key strengths of neural networks is that they can learn abstract representations directly from high-dimensional data such as pixels or words. Having trained HNN models on position and momentum coordinates, we were eager to see whether we could train them on arbitrary\ncoordinates like the latent vectors of an autoencoder.\nTask 5: Pixel Pendulum. With this in mind, we constructed a dataset of pixel observations of a pendulum and then combined an autoencoder with an HNN to model its dynamics. To our knowledge this is the first instance of a Hamiltonian learned directly from pixel data."
        },
        {
            "heading": "5.1 Methods",
            "text": "In recent years, OpenAI Gym has been widely adopted by the machine learning community as a means for training and evaluating reinforcement learning agents [5]. Some works have even trained world models on these environments [15, 16]. Seeing these efforts as related and complimentary to our work, we used OpenAI Gym\u2019s Pendulum-v0 environment in this experiment.\nFirst, we generated 200 trajectories of 100 frames each4. We required that the maximum absolute displacement of the pendulum arm be \u03c06 radians. Starting from 400 x 400 x 3 RGB pixel observations, we cropped, desaturated, and downsampled them to 28 x 28 x 1 frames and concatenated each frame with its successor so that the input to our model was a tensor of shape batch x 28 x 28 x 2. We used two frames so that velocity would be observable from the input. Without the ability to observe velocity, an autoencoder without recurrence would be unable to ascertain the system\u2019s full state space.\nIn designing the autoencoder portion of the model, our main objective was simplicity and trainability. We chose to use fully-connected layers in lieu of convolutional layers because they are simpler. Furthermore, convolutional layers sometimes struggle to extract even simple position information [23]. Both the encoder and decoder were composed of four fully-connected layers with relu activations and residual connections. We used 200 hidden units on all layers except the latent vector z, where we used two units. As for the HNN component of this model, we used the same architecture and parameters as described in Section 3. Unless otherwise specified, we used the same training procedure as described in Section 4.1. We found that using a small amount of weight decay, 10\u22125 in this case, was beneficial.\nLosses. The most notable difference between this experiment and the others was the loss function. This loss function was composed of three terms: the first being the HNN loss, the second being a classic autoencoder loss (L2 loss over pixels), and the third being an auxiliary loss on the autoencoder\u2019s\n4Choosing the \u201cno torque\u201d action at every timestep.\nlatent space:\nLCC = \u2225\u2225ztp \u2212 (ztq \u2212 zt+1q )\u2225\u22252 (7)\nThe purpose of the auxiliary loss term, given in Equation 7, was to make the second half of z, which we\u2019ll label zp, resemble the derivatives of the first half of z, which we\u2019ll label zq. This loss encouraged the latent vector (zq, zp) to have roughly same properties as canonical coordinates (q,p). These properties, measured by the Poisson bracket relations, are necessary for writing a Hamiltonian. We found that the auxiliary loss did not degrade the autoencoder\u2019s performance. Furthermore, it is not domain-specific and can be used with any autoencoder with an even-sized latent space."
        },
        {
            "heading": "5.2 Results",
            "text": "Unlike the baseline model, the HNN learned to conserve a scalar quantity analogous to the total energy of the system. This enabled it to predict accurate dynamics for the system over much longer timespans. Figure 4 shows a qualitative comparison of trajectories predicted by the two models. As in previous experiments, we computed these dynamics using Equation 2 and a fourth-order Runge-Kutta integrator. Unlike previous experiments, we performed this integration in the latent space of the autoencoder. Then, after integration, we projected to pixel space using the decoder network. The HNN and its baseline reached comparable train and test losses, but once again, the HNN dramatically outperformed the baseline on the energy metric (Table 1)."
        },
        {
            "heading": "6 Useful properties of HNNs",
            "text": "While the main purpose of HNNs is to endow neural networks with better physics priors, in this section we ask what other useful properties these models might have.\nAdding and removing energy. So far, we have seen that integrating the symplectic gradient of the Hamiltonian can give us the time evolution of a system but we have not tried following the Riemann gradient RH = ( \u2202H \u2202q , \u2202H \u2202p ) . Intuitively, this corresponds to adding or removing some of the HNN-conserved quantity from the system. It\u2019s especially interesting to alternate between integrating RH and SH. Figure 5 shows how we can take advantage of this effect to \u201cbump\u201d the pendulum to a higher energy level. We could imagine using this technique to answer counterfactual questions e.g. \u201cWhat would have happened if we applied a torque?\u201d\nPerfect reversibility. As neural networks have grown in size, the memory consumption of transient activations, the intermediate activations saved for backpropagation, has become a notable bottleneck. Several works propose semireversible models that construct one layer\u2019s activations from the activations of the next [13, 25, 19]. Neural ODEs\nalso have this property [7]. Many of these models are only approximately reversible: their mappings are not quite bijective. Unlike those methods, our approach is guaranteed to produce trajectories that are perfectly reversible through time. We can simply refer to a result from Hamiltonian mechanics called Liouville\u2019s Theorem: the density of particles in phase space is constant. What this implies is that any mapping (q0,p0)\u2192 (q1,p1) is bijective/invertible."
        },
        {
            "heading": "7 Related work",
            "text": "Learning physical laws from data. Schmidt & Lipson [35] used a genetic algorithm to search a space of mathematical functions for conservation laws and recovered the Lagrangians and Hamiltonians of several real systems. We were inspired by their approach, but used a neural neural network to avoid constraining our search to a set of hand-picked functions. Two recent works are similar to this paper in that the authors sought to uncover physical laws from data using neural networks [18, 4]. Unlike our work, they did not explicitly parameterize Hamiltonians.\nPhysics priors for neural networks. A wealth of previous works have sought to furnish neural networks with better physics priors. Many of these works are domain-specific: the authors used domain knowledge about molecular dynamics [31, 38, 8, 28], quantum mechanics [36], or robotics [24] to help their models train faster or generalize. Others, such as Interaction Networks or Relational Networks were meant to be fully general [43, 34, 2]. Here, we also aimed to keep our approach fully general while introducing a strong and theoretically-motivated prior.\nModeling energy surfaces. Physicists, particularly those studying molecular dynamics, have seen success using neural networks to model energy surfaces [3, 11, 36, 44]. In particular, several works have shown dramatic computation speedups compared to density functional theory [31, 38, 8]. Molecular dynamics researchers integrate the derivatives of energy in order to obtain dynamics, just as we did in this work. A key difference between these approaches and our own is that 1) we emphasize the Hamiltonian formalism 2) we optimize the gradients of our model (though some works do optimize the gradients of a molecular dynamics model [42, 28])."
        },
        {
            "heading": "8 Discussion",
            "text": "Whereas Hamiltonian mechanics is an old and well-established theory, the science of deep learning is still in its infancy. Whereas Hamiltonian mechanics describes the real world from first principles, deep learning does so starting from data. We believe that Hamiltonian Neural Networks, and models like them, represent a promising way of bringing together the strengths of both approaches."
        },
        {
            "heading": "9 Acknowledgements",
            "text": "Sam Greydanus would like to thank the Google AI Residency Program for providing extraordinary mentorship and resources. The authors would like to thank Nic Ford, Trevor Gale, Rapha Gontijo Lopes, Keren Gu, Ben Caine, Mark Woodward, Stephan Hoyer, Jascha Sohl-Dickstein, and many others for insightful conversations and support.\nSpecial thanks to James and Judy Greydanus for their feedback and support from beginning to end."
        },
        {
            "heading": "A Supplementary Information for Tasks 1-3",
            "text": "Training details. We selected hyperparameters using a coarse grid search over learning rates {10\u22121, 10\u22122, 10\u22123}, layer widths {100, 200, 300}, activations {tanh, relu}, and batch size where relevant {100, 200}. The main objective of this work was not to produce state-of-the-art results, so the settings we chose were aimed simply at producing models that gave good qualitative performance on the tasks at hand. We used weight decay of 10\u22124 on the first three tasks.\nWe trained all of these experiments on a desktop CPU.\nThe train/test split on Task 3. We partitioned the train and test sets on Task 3 in an unusual manner. The dataset provided by [35] consisted of just a single trajectory from a real pendulum, as shown in the second panel of Figure 2(c). We needed to evaluate our model\u2019s performance over a series of adjacent time steps in order to measure the energy MSE metric. For this reason, we were forced to use the first 4/5 of this trajectory for training (black vectors in Figure 2(c)) and the last 1/5 for evaluation (red vectors).\nThe consequence of this train/test split is that our test set had a slightly different distribution from our training set. We found that the relative magnitudes of the test losses between the baseline and HNN models were informative. We did not perform this ungainly train/test split on the other two tasks in this section."
        },
        {
            "heading": "B Supplementary Information for Task 4: Two-body problem",
            "text": "Training details. We selected hyperparameters with a grid search as described in the previous section. Again, the main objective of this work was not to produce state-of-the-art results, so the settings we chose were aimed simply at producing models that gave good qualitative performance on the tasks at hand. We did not use weight decay on this task, though when we tried a weight decay of 10\u22124 or results did not change significantly.\nWe trained this experiment on a desktop CPU.\nThree body problem. As mentioned briefly in the body of the paper, we also trained our models on the three body problem. The results we report here show a relative advantage to using the HNN over the baseline model. However, both models struggled to accurately model the dynamics of the three-body problem, which is why we relegated these results to the Appendix. Going forward, we hope to improve these results to the point where they can play a more substantial role in Section 4.\nTable 2 gives a summary of quantitative results and Figure B.3 shows a qualitative analysis of the models we trained on this task."
        },
        {
            "heading": "C Supplementary Information for Task 5: Pixel Pendulum",
            "text": "Training details. We selected hyperparameters with a grid search as described in the previous section. We used a weight decay of 10\u22125 on this experiment. We found that, unlike previous experiments, weight decay had a significant impact on results. We suspect that this is because the scale of the gradients on the weights of the HNN portion of the model were different from the scale of the gradients of the weights of the autoencoder portion of the model.\nWe trained this experiment on a desktop CPU."
        }
    ],
    "title": "Hamiltonian Neural Networks",
    "year": 2019
}